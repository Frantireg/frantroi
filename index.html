<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramientas CUPS (Generador y Calculadora)</title>
    <style>
        /* PALETA 60-30-10 (Pastel) */
        :root {
            /* 60% Dominante: Blanco Roto (Fondo de Recuadros/Contenedor) */
            --color-dominante: #F5F5F5;
            /* 30% Secundario: Lavanda Muy Claro (Fondo de P√°gina) */
            --color-secundARIO: #E8EAF6;
            /* 10% Acento: Menta Suave (Botones Copiar, Borde) */
            --color-acento: #A8DAD7;
            /* Contraste: P√∫rpura del Logo (T√≠tulos, Bot√≥n Generar) */
            --color-contraste: #6A5ACD;
            /* Gris Suave (Texto general) */
            --color-texto-general: #555555;
            /* Rojo para errores */
            --color-error: #d9534f;
        }


        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--color-secundario);
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .logo {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            background-color: var(--color-contraste);
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo img {
            /* IMPORTANTE: Ajusta el nombre del archivo del logo aqu√≠ */
            content: url("Captura de pantalla 2025-10-09 183230.png");
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px;
            background-color: var(--color-dominante);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: var(--color-contraste);
            text-align: center;
            border-bottom: 2px solid var(--color-acento);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h2 {
            color: var(--color-contraste);
            font-size: 1.3em;
            margin-top: 20px;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--color-acento);
        }
        
        /* --- ESTILOS PARA TABS --- */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--color-acento);
            padding-bottom: 15px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background-color: var(--color-secundario); /* Inactive state */
            color: var(--color-texto-general);
            border: 1px solid var(--color-acento);
            font-size: 1em;
            font-weight: bold;
        }
        .tab-btn:hover {
            background-color: var(--color-acento);
        }
        .tab-btn.active {
            background-color: var(--color-contraste); /* Active state */
            color: white;
            border-color: var(--color-contraste);
        }
        .tab-btn.active:hover {
            background-color: #5d49b2;
        }
        
        
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        .input-group label {
            font-weight: bold;
            color: var(--color-contraste);
            white-space: nowrap;
        }
        
        /* Estilo unificado para inputs y el nuevo select */
        input[type="text"], 
        input[type="number"],
        select {
            padding: 12px;
            border: 1px solid var(--color-contraste);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: white;
            color: var(--color-texto-general);
        }
        
        input[type="text"], select { 
            flex: 2; 
        }
        input[type="number"] { 
            flex: 1; 
            max-width: 120px; 
            text-align: center; 
        }


        button {
            padding: 12px 20px;
            cursor: pointer;
            background-color: var(--color-contraste);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #5d49b2; }

        button.reset-btn {
            background-color: var(--color-acento);
            color: var(--color-texto-general);
        }
        button.reset-btn:hover {
            background-color: #88c8c5;
        }

        .export-controls {
            text-align: right;
            margin-bottom: 15px;
        }
        button.export-btn {
            background-color: var(--color-acento);
            color: var(--color-texto-general);
            padding: 8px 15px;
            font-size: 0.9em;
        }
        button.export-btn:hover {
            background-color: #88c8c5;
        }

        #statusMessage {
            color: var(--color-error);
            margin-top: 15px;
            font-weight: bold;
        }
        .results-grid {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .column {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            background-color: var(--color-secundario);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }
        .cups-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border: 1px solid var(--color-acento);
            border-radius: 6px;
        }
        .cups-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .list-number {
            font-weight: bold;
            color: white;
            background-color: var(--color-contraste);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .cups-code {
            font-family: monospace;
            font-size: 1.05em;
            color: var(--color-contraste);
            font-weight: bold;
        }
        
        .nota-input {
            padding: 0 6px;    
            border: 1px solid var(--color-acento);
            border-radius: 4px;  
            font-size: 0.7em;    
            width: 120px; 
            box-sizing: border-box; 
            font-family: monospace;
            color: var(--color-texto-general);
        }

        .copy-btn {
            padding: 6px 10px;
            background-color: var(--color-acento);
            color: var(--color-texto-general);
            font-size: 0.9em;
        }
        .copy-btn:hover { background-color: #88c8c5; }

        .copy-btn.copied {
            background-color: var(--color-secundario);
            color: var(--color-texto-general);
            border: 1px solid var(--color-acento);
        }
        .copy-btn.copied:hover {
            background-color: #88c8c5;
        }


        .original-cups {
            background-color: #FFDDAA;
            color: var(--color-texto-general);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* --- ESTILOS PARA CALCULADORA (ADAPTADO) --- */
        #calculadora-content .input-prefix {
            padding: 8px 12px;
            font-weight: bold;
            color: var(--color-contraste);
            background-color: var(--color-secundario);
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1em;
            white-space: nowrap;
        }

        #calculadora-content input[type="text"] {
            font-family: monospace;
            letter-spacing: 1px;
            font-size: 1.05em;
            text-align: center;
        }
        
        #calculadoraResults {
            min-height: 200px; 
            max-height: 400px; 
            overflow-y: auto;
            font-family: monospace;
            font-size: 1.05em;
            color: var(--color-contraste);
            line-height: 1.6;
        }
        
        #calculadoraResults p {
            color: var(--color-texto-general);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1em;
            font-weight: normal;
        }

        /* Clase de error para la calculadora */
        .error {
            color: var(--color-error);
            font-weight: bold;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        

        /* NOTIFICACI√ìN TEMPORAL (Snackbar) */
        #snackbar {
            visibility: hidden;
            min-width: 280px;
            margin-left: -140px;
            background-color: var(--color-contraste);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        #snackbar.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        .page-footer {
            text-align: center;
            padding: 20px;
            font-size: 0.8em;
            color: var(--color-texto-general);
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                </div>
            <h1>Herramientas CUPS</h1>
        </div>

        <div class="tab-nav">
            <button id="tab-generador" class="tab-btn active" onclick="showTab('generador')">Generador Secuencial üîÑ</button>
            <button id="tab-calculadora" class="tab-btn" onclick="showTab('calculadora')">Completar CUPS üîç</button>
        </div>


        <div id="generador-content">
            <p>Introduce el CUPS base y la cantidad de c√≥digos anteriores y posteriores que deseas generar.</p>

            <div class="input-group">
                <label for="cupsInput">CUPS Base:</label>
                <input type="text" id="cupsInput" placeholder="Ej: ES0022000000000000" value="ES0022000000000000XX">
           
                <label for="quantityInput">Cantidad:</label>
                <input type="number" id="quantityInput" value="10" min="1" max="50">
           
                <button onclick="generarCups()">Generar</button>
                
                <button onclick="restablecerTodo()" class="reset-btn">Restablecer</button>
            </div>
            <div id="statusMessage"></div>
            <div id="originalCupsDisplay" class="original-cups" style="display: none;"></div>

            <hr>

            <div class="export-controls">
                <button id="exportButton" class="export-btn" onclick="copiarTodoAExcel()" style="display: none;">
                    Copiar Todo para Excel üìã
                </button>
            </div>

            <div class="results-grid">
                <div class="column">
                    <h2 id="anterioresTitle">CUPS Anteriores ‚¨ÖÔ∏è</h2>
                    <div id="anterioresList">
                        </div>
                </div>
                <div class="column">
                    <h2 id="posterioresTitle">CUPS Posteriores ‚û°Ô∏è</h2>
                    <div id="posterioresList">
                        </div>
                </div>
            </div>
        </div>


        <div id="calculadora-content" style="display: none;">
            
            <h2>Completar CUPS</h2>
            
            <div class="input-group">
                <label for="modeSelect">Modo de C√°lculo:</label>
                <select id="modeSelect" onchange="updateInputView()">
                    <option value="3" selected>Faltan 3 d√≠gitos (ES...XXX...)</option>
                    <option value="4">Faltan 4 d√≠gitos (ES...XXXX...)</option>
                </select>
            </div>
            
            <p>Introduce las partes conocidas (Y) del CUPS:</p>

            <div id="inputGroup3" class="input-group">
                <label>CUPS (sin 3 d√≠gitos):</label>
                <span class="input-prefix">ES</span>
                <input type="text" id="cupsP1_3" maxlength="9" placeholder="YYYYYYYYY" list="predefined-p1" style="flex: 2;">
                <datalist id="predefined-p1">
                    <option value="002200000">
                    <option value="002100000">
                    <option value="002100001">
                </datalist>
                <span class="input-prefix">XXX</span>
                <input type="text" id="cupsP2_3" maxlength="6" placeholder="YYYYCC" style="flex: 1; max-width: 140px;">
            </div>

            <div id="inputGroup4" class="input-group" style="display: none;">
                <label>CUPS (sin 4 d√≠gitos):</label>
                <span class="input-prefix">ES</span>
                <input type="text" id="cupsP1_4" maxlength="8" placeholder="YYYYYYYY" style="flex: 2;">
                <span class="input-prefix">XXXX</span>
                <input type="text" id="cupsP2_4" maxlength="6" placeholder="YYYYCC" style="flex: 1; max-width: 140px;">
            </div>
            
            <div class="input-group">
                <button onclick="findValidCups()" style="width: 100%;">Calcular Posibles CUPS</button>
            </div>
            
            <h3>Resultados:</h3>
            <div id="calculadoraResults" class="column">
                <p>Aqu√≠ aparecer√°n los CUPS v√°lidos...</p>
            </div>
        </div>

    </div> 

    <footer class="page-footer">
        Creado por Fran T.
    </footer>

    <div id="snackbar"></div>


    <script>
        // --- OBTENER REFERENCIAS DEL DOM (Comunes y nuevas) ---
        
        // Comunes
        const snackbar = document.getElementById('snackbar');
        
        // Pesta√±as
        const tabGenerador = document.getElementById('tab-generador');
        const tabCalculadora = document.getElementById('tab-calculadora');
        const generadorContent = document.getElementById('generador-content');
        const calculadoraContent = document.getElementById('calculadora-content');
        
        // Generador
        const cupsInput = document.getElementById('cupsInput');
        const quantityInput = document.getElementById('quantityInput');
        const anterioresList = document.getElementById('anterioresList');
        const posterioresList = document.getElementById('posterioresList');
        const originalesDisplay = document.getElementById('originalCupsDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const anterioresTitle = document.getElementById('anterioresTitle');
        const posterioresTitle = document.getElementById('posterioresTitle');
        const exportButton = document.getElementById('exportButton');

        // Calculadora (Referencia al div de resultados)
        const calculadoraResults = document.getElementById('calculadoraResults');


        // --- CONSTANTES GLOBALES ---
        
        /* REGEX Generador:
            Grupo 1: LL (ES)
            Grupo 2: DDDD (0022)
            Grupo 3: CCCCCCCCCC (000000000000)
            (Grupo no capturado): EE (XX) - D√≠gitos de control opcionales (?:[A-Z]{2})?
            Grupo 4: Final opcional (PF, 01, etc.) ([A-Z0-9]{0,2})?
        */
        const CUPS_REGEX = /^([A-Z]{2})(\d{4})(\d{12})(?:[A-Z]{2})?([A-Z0-9]{0,2})?/;
        const CUPS_CHAR_TABLE = "TRWAGMYFPDXBNJZSQVHLCKE"; // Usada por ambas herramientas
        const COUNTER_KEY = 'generadorCupsConteo';


        // --- FUNCIONES COMUNES ---

        /**
         * Muestra la notificaci√≥n temporalmente (Snackbar).
         */
        function showSnackbar(message) {
            snackbar.textContent = message;
            snackbar.classList.add('show');
       
            setTimeout(function(){
                snackbar.classList.remove('show');
            }, 3000);
        }

        /**
         * Calcula los 2 d√≠gitos de control (EE) para los 16 d√≠gitos num√©ricos.
         * (Usado por ambas herramientas)
         */
        function calcularDigitosControl(dddccccccccccc) {
            try {
                const numero16Digitos = BigInt(dddccccccccccc);
        
                // R0 = DDDDCCCCCCCCCCCC Modulo 529
                const R0 = Number(numero16Digitos % 529n);

                // C = parte entera de R0 / 23; R = R0 Modulo 23
                const C = Math.floor(R0 / 23);
                const R = R0 % 23;

                // Transformar C y R por la tabla
                const letraC = CUPS_CHAR_TABLE.charAt(C);
                const letraR = CUPS_CHAR_TABLE.charAt(R);

                return letraC + letraR;
            } catch (e) {
                console.error("Error al calcular d√≠gitos de control:", e);
                return "ER"; // Retorno de error
            }
        }

        /**
         * Copia un texto dado al portapapeles.
         */
        async function copiarAlPortapapeles(textToCopy, btnElement) {
            try {
                await navigator.clipboard.writeText(textToCopy);
                showSnackbar(`‚úÖ CUPS copiado: ${textToCopy}`);
                
                if (btnElement) {
                    btnElement.classList.add('copied');
                    btnElement.textContent = '‚úî';
                }

            } catch (err) {
                console.error('Error al copiar el texto: ', err);
                alert('‚ùå Error al intentar copiar al portapapeles. Aseg√∫rate de que tu navegador lo permite (la p√°gina debe ser servida por HTTPS o localhost).');
            }
        }
        
        /**
         * Muestra el panel (tab) seleccionado.
         */
        function showTab(tabName) {
            // Ocultar todos los contenidos
            generadorContent.style.display = 'none';
            calculadoraContent.style.display = 'none';

            // Quitar 'active' de todos los botones
            tabGenerador.classList.remove('active');
            tabCalculadora.classList.remove('active');

            // Mostrar el contenido y activar el bot√≥n seleccionado
            if (tabName === 'generador') {
                generadorContent.style.display = 'block';
                tabGenerador.classList.add('active');
            } else if (tabName === 'calculadora') {
                calculadoraContent.style.display = 'block';
                tabCalculadora.classList.add('active');
            }
        }


        // --- FUNCIONES DEL GENERADOR ---

        /**
         * (GENERADOR) Funci√≥n para copiar todos los datos a Excel
         */
        async function copiarTodoAExcel() {
            let excelData = "";
            const tab = '\t'; // Car√°cter Tabulador (clave para separar columnas en Excel)
            const newline = '\n'; // Salto de l√≠nea

            // 1. Obtener todos los items
            const itemsAnteriores = document.querySelectorAll('#anterioresList .cups-item');
            const itemsPosteriores = document.querySelectorAll('#posterioresList .cups-item');
            
            // 2. Procesar "Anteriores"
            const itemsAnterioresArray = Array.from(itemsAnteriores).reverse();
            itemsAnterioresArray.forEach(item => {
                const cups = item.querySelector('.cups-code').textContent;
                const nota = item.querySelector('.nota-input').value;
                excelData += `${cups}${tab}${nota}${newline}`;
            });

            // 3. Procesar "Posteriores"
            itemsPosteriores.forEach(item => {
                const cups = item.querySelector('.cups-code').textContent;
                const nota = item.querySelector('.nota-input').value;
                excelData += `${cups}${tab}${nota}${newline}`;
            });

            // 4. Copiar al portapapeles
            if (excelData) {
                try {
                    await navigator.clipboard.writeText(excelData.trim());
                    showSnackbar('‚úÖ Todos los CUPS y notas copiados para Excel.');
                } catch (err) {
                    console.error('Error al copiar todo: ', err);
                    alert('‚ùå Error al copiar. Revisa los permisos del navegador.');
                }
            } else {
                showSnackbar('‚ÑπÔ∏è No hay datos para copiar.');
            }
        }

        /**
         * (GENERADOR) Funci√≥n auxiliar para calcular el CUPS completo (parte del BigInt y control).
         */
        function calculateFullCups(baseNumber, countryCode, distributorCode, optionalEnd) {
            const newNumericPart = baseNumber.toString().padStart(12, '0');
            const dddccccccccccc = distributorCode + newNumericPart;
            const newControlDigits = calcularDigitosControl(dddccccccccccc); // Reutiliza la funci√≥n com√∫n
       
            return `${countryCode}${distributorCode}${newNumericPart}${newControlDigits}${optionalEnd || ''}`;
        }

        /**
         * (GENERADOR) Funci√≥n principal para generar y mostrar los CUPS secuenciales.
         */
        function generarCups() {
            const fullCups = cupsInput.value.trim().toUpperCase();
            let quantity = parseInt(quantityInput.value, 10);

            // --- L√≥gica del Contador ---
            const resetMatch = fullCups.match(/^CONTADOR A (\d+)$/);

            if (resetMatch) {
                // Acci√≥n: Resetear contador
                const newCount = parseInt(resetMatch[1], 10);
                if (!isNaN(newCount)) {
                    localStorage.setItem(COUNTER_KEY, newCount.toString());
                    statusMessage.textContent = `‚úÖ Contador reseteado a ${newCount}.`;
                } else {
                    statusMessage.textContent = 'Error: El n√∫mero para resetear no es v√°lido.';
                }
                anterioresList.innerHTML = '';
                posterioresList.innerHTML = '';
                originalesDisplay.style.display = 'none';
                exportButton.style.display = 'none';
                return;
            }

            if (fullCups === 'CONTADOR') {
                // Acci√≥n: Mostrar contador
                const currentCount = localStorage.getItem(COUNTER_KEY) || '0';
                statusMessage.textContent = `Veces usado "Generar": ${currentCount}.`;
                // Limpiar resultados para que no confunda
                anterioresList.innerHTML = '';
                posterioresList.innerHTML = '';
                originalesDisplay.style.display = 'none';
                exportButton.style.display = 'none';
                return;
            }
            // --- FIN L√≥gica del Contador ---

       
            if (isNaN(quantity) || quantity < 1 || quantity > 50) { 
                quantity = 10;
                quantityInput.value = 10;
                statusMessage.textContent = 'Cantidad ajustada a 10 (m√≠n: 1, m√°x: 50).';
            } else {
                statusMessage.textContent = '';
            }
       
            // Limpiar resultados anteriores
            anterioresList.innerHTML = '';
            posterioresList.innerHTML = '';
            originalesDisplay.style.display = 'none';
            exportButton.style.display = 'none'; 
       
            // Actualizar t√≠tulos
            anterioresTitle.textContent = `${quantity} CUPS Anteriores ‚¨ÖÔ∏è`;
            posterioresTitle.textContent = `${quantity} CUPS Posteriores ‚û°Ô∏è`;


            const match = fullCups.match(CUPS_REGEX);


            if (!match) {
                statusMessage.textContent = 'Formato CUPS inv√°lido. Debe empezar con LLDDDDCCCCCCCCCCCC (18 caracteres).';
                return;
            }

            // --- Incrementar contador (SOLO si el CUPS es v√°lido) ---
            try {
                let currentCount = parseInt(localStorage.getItem(COUNTER_KEY) || '0', 10);
                currentCount++;
                localStorage.setItem(COUNTER_KEY, currentCount.toString());
            } catch (e) {
                console.error("Error al acceder a localStorage: ", e);
            }
            // --- FIN Incrementar contador ---


            const [_, countryCode, distributorCode, numericPart, optionalEnd] = match;
            const baseNumber = parseInt(numericPart, 10);
       
            // 1. Procesar CUPS anteriores
            for (let i = 1; i <= quantity; i++) {
                const itemNumber = baseNumber - i;
                const newCups = calculateFullCups(itemNumber, countryCode, distributorCode, optionalEnd);
                displayCupsItem(newCups, anterioresList, i);
            }
       
            // 2. Procesar CUPS posteriores
            for (let i = 1; i <= quantity; i++) {
                const itemNumber = baseNumber + i;
                const newCups = calculateFullCups(itemNumber, countryCode, distributorCode, optionalEnd);
                displayCupsItem(newCups, posterioresList, i);
            }

            
            // 3. Mostrar el CUPS Original
            const completeBaseCups = calculateFullCups(baseNumber, countryCode, distributorCode, optionalEnd);
            originalesDisplay.textContent = `CUPS Original: ${completeBaseCups}`;
            originalesDisplay.style.display = 'block';
            
            exportButton.style.display = 'inline-block';
        }
        
        /**
         * (GENERADOR) Funci√≥n para restablecer la interfaz
         */
        function restablecerTodo() {
            // Restablecer valores de entrada a sus valores por defecto
            cupsInput.value = 'ES0022000000000000XX'; 
            quantityInput.value = '10';

            // Limpiar listas de resultados
            anterioresList.innerHTML = '';
            posterioresList.innerHTML = '';

            // Limpiar mensaje de estado
            statusMessage.textContent = '';

            // Ocultar el display del CUPS original
            originalesDisplay.style.display = 'none';

            exportButton.style.display = 'none';

            // Restablecer t√≠tulos de las columnas
            anterioresTitle.textContent = 'CUPS Anteriores ‚¨ÖÔ∏è';
            posterioresTitle.textContent = 'CUPS Posteriores ‚û°Ô∏è';
        }

        /**
         * (GENERADOR) Crea y a√±ade un elemento de lista para un CUPS.
         */
        function displayCupsItem(cupsCode, targetList, listNumber) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('cups-item');

            const cupsInfo = document.createElement('div');
            cupsInfo.classList.add('cups-info');
       
            // N√∫mero de lista
            const numberSpan = document.createElement('span');
            numberSpan.classList.add('list-number');
            numberSpan.textContent = listNumber;

            // C√≥digo CUPS
            const cupsSpan = document.createElement('span');
            cupsSpan.classList.add('cups-code');
            cupsSpan.textContent = cupsCode;

            cupsInfo.appendChild(numberSpan);
            cupsInfo.appendChild(cupsSpan);
       
            // Campo de Notas
            const notaInput = document.createElement('input');
            notaInput.type = 'text';
            notaInput.classList.add('nota-input');
            notaInput.placeholder = '';
            notaInput.maxLength = 12;
            cupsInfo.appendChild(notaInput);

            // Bot√≥n de copia
            const copyButton = document.createElement('button');
            copyButton.classList.add('copy-btn');
            copyButton.textContent = 'Copiar';
            
            copyButton.onclick = () => copiarAlPortapapeles(cupsCode, copyButton);

            itemDiv.appendChild(cupsInfo);
            itemDiv.appendChild(copyButton);
       
            targetList.appendChild(itemDiv);
        }

        
        // --- FUNCIONES DE LA CALCULADORA (ACTUALIZADAS de calculocups2.html) ---

        /**
         * (CALCULADORA) Muestra/Oculta el grupo de inputs correcto.
         */
        function updateInputView() {
            const mode = document.getElementById('modeSelect').value;
            
            if (mode === '3') {
                document.getElementById('inputGroup3').style.display = 'flex';
                document.getElementById('inputGroup4').style.display = 'none';
            } else {
                document.getElementById('inputGroup3').style.display = 'none';
                document.getElementById('inputGroup4').style.display = 'flex';
            }
            calculadoraResults.innerHTML = '<p>Aqu√≠ aparecer√°n los CUPS v√°lidos...</p>'; // Limpia resultados
        }


        /**
         * (CALCULADORA) Funci√≥n principal - MODIFICADA PARA MANEJAR AMBOS MODOS
         */
        function findValidCups() {
            const mode = document.getElementById('modeSelect').value;
            // Usamos la referencia al div de resultados
            
            let p1_known, p2_suffix, p1_length, loopMax, padLength, errorMsg;

            // 1. Configurar variables seg√∫n el modo
            if (mode === '3') {
                p1_known = document.getElementById('cupsP1_3').value;
                p2_suffix = document.getElementById('cupsP2_3').value.toUpperCase();
                p1_length = 9;
                loopMax = 999;
                padLength = 3;
                errorMsg = '<p class="error">Error: El primer campo (YYYYYYYYY) debe contener exactamente 9 d√≠gitos num√©ricos.</p>';
                calculadoraResults.innerHTML = "<p>Calculando (0-999)...</p>";
            } else { // mode === '4'
                p1_known = document.getElementById('cupsP1_4').value;
                p2_suffix = document.getElementById('cupsP2_4').value.toUpperCase();
                p1_length = 8;
                loopMax = 9999;
                padLength = 4;
                errorMsg = '<p class="error">Error: El primer campo (YYYYYYYY) debe contener exactamente 8 d√≠gitos num√©ricos.</p>';
                calculadoraResults.innerHTML = "<p>Calculando (0-9999)...</p>";
            }

            // 2. Validar entradas
            if (p1_known.length !== p1_length || !/^\d+$/.test(p1_known)) {
                calculadoraResults.innerHTML = errorMsg;
                return;
            }
            
            if (p2_suffix.length !== 6 || !/^\d{4}[A-Z]{2}$/.test(p2_suffix)) {
                 calculadoraResults.innerHTML = '<p class="error">Error: El segundo campo (YYYYCC) debe contener 4 d√≠gitos y 2 letras de control (ej: 1234TR).</p>';
                return;
            }

            // 3. Extraer partes
            const p3_known = p2_suffix.substring(0, 4);
            const expectedControls = p2_suffix.substring(4, 6);
            
            const validResults = [];

            // 4. Iterar por todas las posibilidades (bucle gen√©rico)
            for (let i = 0; i <= loopMax; i++) {
                const p2_unknown = i.toString().padStart(padLength, '0');
                
                // 5. Construir el n√∫mero de 16 d√≠gitos
                const N_string = p1_known + p2_unknown + p3_known;
                
                // 6. Calcular los d√≠gitos de control
                // --- REUTILIZAMOS LA FUNCI√ìN GLOBAL ---
                const calculatedControls = calcularDigitosControl(N_string);
                
                // 7. Comparar con los d√≠gitos esperados
                if (calculatedControls === expectedControls) {
                    const validCups = "ES" + p1_known + p2_unknown + p3_known + expectedControls;
                    validResults.push(validCups);
                }
            }

            // 8. Mostrar los resultados
            if (validResults.length > 0) {
                calculadoraResults.innerHTML = validResults.join('<br>');
            } else {
                calculadoraResults.innerHTML = "<p>No se encontraron CUPS v√°lidos para ese patr√≥n y d√≠gitos de control.</p>";
            }
        }


        // --- HACER FUNCIONES ACCESIBLES GLOBALMENTE ---
        
        // Generador
        window.copiarAlPortapapeles = copiarAlPortapapeles;
        window.generarCups = generarCups;
        window.restablecerTodo = restablecerTodo;
        window.copiarTodoAExcel = copiarTodoAExcel;
        
        // Calculadora
        window.findValidCups = findValidCups; 
        window.updateInputView = updateInputView; // <-- A√±adida la nueva funci√≥n
        
        // Navegaci√≥n
        window.showTab = showTab;
        
    </script>
</body>
</html>
