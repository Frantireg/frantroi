<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramientas CUPS (Privado)</title>
    <style>
        /* PALETA 60-30-10 (Pastel) */
        :root {
            --color-dominante: #F5F5F5;
            --color-secundARIO: #E8EAF6;
            --color-acento: #A8DAD7;
            --color-contraste: #6A5ACD;
            --color-texto-general: #555555;
            --color-error: #d9534f;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--color-secundario);
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            flex-direction: column;
        }
        .logo-title-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            background-color: var(--color-contraste);
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo img {
            /* Ajusta la ruta de tu imagen si es necesario */
            content: url("Captura de pantalla 2025-10-09 183230.png");
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px;
            background-color: var(--color-dominante);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: var(--color-contraste);
            text-align: center;
            border-bottom: 2px solid var(--color-acento);
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        
        /* Estilo para el contador global (Oculto por defecto en el HTML) */
        .global-counter {
            font-size: 0.9em;
            color: var(--color-texto-general);
            background-color: var(--color-acento);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            opacity: 0.8;
            margin-top: 10px;
            cursor: pointer; /* Para indicar que se puede cerrar si quieres */
        }

        h2 {
            color: var(--color-contraste);
            font-size: 1.3em;
            margin-top: 20px;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--color-acento);
        }
        
        /* TABS */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--color-acento);
            padding-bottom: 15px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background-color: var(--color-secundario);
            color: var(--color-texto-general);
            border: 1px solid var(--color-acento);
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        .tab-btn:hover { background-color: var(--color-acento); }
        .tab-btn.active {
            background-color: var(--color-contraste);
            color: white;
            border-color: var(--color-contraste);
        }
        .tab-btn.active:hover { background-color: #5d49b2; }
        
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        .input-group label {
            font-weight: bold;
            color: var(--color-contraste);
            white-space: nowrap;
        }
        
        input[type="text"], input[type="number"], select {
            padding: 12px;
            border: 1px solid var(--color-contraste);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: white;
            color: var(--color-texto-general);
        }
        input[type="text"], select { flex: 2; }
        input[type="number"] { flex: 1; max-width: 120px; text-align: center; }

        button {
            padding: 12px 20px;
            cursor: pointer;
            background-color: var(--color-contraste);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #5d49b2; }

        button.reset-btn {
            background-color: var(--color-acento);
            color: var(--color-texto-general);
        }
        button.reset-btn:hover { background-color: #88c8c5; }

        .export-controls { text-align: right; margin-bottom: 15px; }
        button.export-btn {
            background-color: var(--color-acento);
            color: var(--color-texto-general);
            padding: 8px 15px;
            font-size: 0.9em;
        }
        button.export-btn:hover { background-color: #88c8c5; }

        #statusMessage {
            color: var(--color-error);
            margin-top: 15px;
            font-weight: bold;
        }
        .results-grid { display: flex; gap: 20px; margin-top: 20px; }
        .column {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            background-color: var(--color-secundario);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }
        .cups-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border: 1px solid var(--color-acento);
            border-radius: 6px;
        }
        .cups-info { display: flex; align-items: center; gap: 10px; }
        .list-number {
            font-weight: bold;
            color: white;
            background-color: var(--color-contraste);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .cups-code {
            font-family: monospace;
            font-size: 1.05em;
            color: var(--color-contraste);
            font-weight: bold;
        }
        .nota-input {
            padding: 0 6px;    
            border: 1px solid var(--color-acento);
            border-radius: 4px;  
            font-size: 0.7em;    
            width: 120px; 
            box-sizing: border-box; 
            font-family: monospace;
            color: var(--color-texto-general);
        }
        .copy-btn {
            padding: 6px 10px;
            background-color: var(--color-acento);
            color: var(--color-texto-general);
            font-size: 0.9em;
        }
        .copy-btn:hover { background-color: #88c8c5; }
        .copy-btn.copied {
            background-color: var(--color-secundario);
            color: var(--color-texto-general);
            border: 1px solid var(--color-acento);
        }
        .copy-btn.copied:hover { background-color: #88c8c5; }

        .original-cups {
            background-color: #FFDDAA;
            color: var(--color-texto-general);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* CALCULADORA */
        #calculadora-content .input-prefix {
            padding: 8px 12px;
            font-weight: bold;
            color: var(--color-contraste);
            background-color: var(--color-secundario);
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1em;
            white-space: nowrap;
        }
        #calculadora-content input[type="text"] {
            font-family: monospace;
            letter-spacing: 1px;
            font-size: 1.05em;
            text-align: center;
        }
        #calculadoraResults {
            min-height: 200px; 
            max-height: 400px; 
            overflow-y: auto;
            font-family: monospace;
            font-size: 1.05em;
            color: var(--color-contraste);
            line-height: 1.6;
        }
        #calculadoraResults p {
            color: var(--color-texto-general);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1em;
            font-weight: normal;
        }
        .error {
            color: var(--color-error);
            font-weight: bold;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* SNACKBAR */
        #snackbar {
            visibility: hidden;
            min-width: 280px;
            margin-left: -140px;
            background-color: var(--color-contraste);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        #snackbar.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        .page-footer {
            text-align: center;
            padding: 20px;
            font-size: 0.8em;
            color: var(--color-texto-general);
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-title-wrapper">
                <div class="logo">
                    </div>
                <h1>Herramientas CUPS</h1>
            </div>
            <div id="nasCounterDisplay" class="global-counter" style="display: none;">
                Cargando datos...
            </div>
        </div>

        <div class="tab-nav">
            <button id="tab-generador" class="tab-btn active" onclick="showTab('generador')">Generador Secuencial üîÑ</button>
            <button id="tab-calculadora" class="tab-btn" onclick="showTab('calculadora')">Completar CUPS üîç</button>
        </div>

        <div id="generador-content">
            <p>Introduce el CUPS base y la cantidad de c√≥digos anteriores y posteriores que deseas generar.</p>
            <div class="input-group">
                <label for="cupsInput">CUPS Base:</label>
                <input type="text" id="cupsInput" placeholder="Ej: ES0022000000000000" value="ES0022000000000000XX">
                <label for="quantityInput">Cantidad:</label>
                <input type="number" id="quantityInput" value="10" min="1" max="50">
                <button onclick="generarCups()">Generar</button>
                <button onclick="restablecerTodo()" class="reset-btn">Restablecer</button>
            </div>
            <div id="statusMessage"></div>
            <div id="originalCupsDisplay" class="original-cups" style="display: none;"></div>
            <hr>
            <div class="export-controls">
                <button id="exportButton" class="export-btn" onclick="copiarTodoAExcel()" style="display: none;">
                    Copiar Todo para Excel üìã
                </button>
            </div>
            <div class="results-grid">
                <div class="column">
                    <h2 id="anterioresTitle">CUPS Anteriores ‚¨ÖÔ∏è</h2>
                    <div id="anterioresList"></div>
                </div>
                <div class="column">
                    <h2 id="posterioresTitle">CUPS Posteriores ‚û°Ô∏è</h2>
                    <div id="posterioresList"></div>
                </div>
            </div>
        </div>

        <div id="calculadora-content" style="display: none;">
            <h2>Completar CUPS</h2>
            <div class="input-group">
                <label for="modeSelect">Modo de C√°lculo:</label>
                <select id="modeSelect" onchange="updateInputView()">
                    <option value="3" selected>Faltan 3 d√≠gitos (ES...XXX...)</option>
                    <option value="4">Faltan 4 d√≠gitos (ES...XXXX...)</option>
                </select>
            </div>
            <p>Introduce las partes conocidas (Y) del CUPS:</p>
            <div id="inputGroup3" class="input-group">
                <label>CUPS (sin 3 d√≠gitos):</label>
                <span class="input-prefix">ES</span>
                <input type="text" id="cupsP1_3" maxlength="9" placeholder="YYYYYYYYY" list="predefined-p1" style="flex: 2;">
                <datalist id="predefined-p1">
                    <option value="002200000">
                    <option value="002100000">
                    <option value="002100001">
                </datalist>
                <span class="input-prefix">XXX</span>
                <input type="text" id="cupsP2_3" maxlength="6" placeholder="YYYYCC" style="flex: 1; max-width: 140px;">
            </div>
            <div id="inputGroup4" class="input-group" style="display: none;">
                <label>CUPS (sin 4 d√≠gitos):</label>
                <span class="input-prefix">ES</span>
                <input type="text" id="cupsP1_4" maxlength="8" placeholder="YYYYYYYY" style="flex: 2;">
                <span class="input-prefix">XXXX</span>
                <input type="text" id="cupsP2_4" maxlength="6" placeholder="YYYYCC" style="flex: 1; max-width: 140px;">
            </div>
            <div class="input-group">
                <button onclick="findValidCups()" style="width: 100%;">Calcular Posibles CUPS</button>
            </div>
            <h3>Resultados:</h3>
            <div id="calculadoraResults" class="column">
                <p>Aqu√≠ aparecer√°n los CUPS v√°lidos...</p>
            </div>
        </div>
    </div> 

    <footer class="page-footer">Creado por Fran T.</footer>
    <div id="snackbar"></div>

    <script>
        /* ==========================================================
           CONFIGURACI√ìN DEL NAS (BACKEND)
           ========================================================== */
        // Aseg√∫rate de poner http:// (no https todav√≠a, para evitar l√≠os de certificados por ahora)
	const NAS_URL = "https://franti.synology.me/api.php";

        const nasCounterDisplay = document.getElementById('nasCounterDisplay');

        /**
         * Funci√≥n para obtener los datos del NAS y MOSTRARLOS
         * (Solo se llama cuando se escribe la palabra clave)
         */
        async function fetchNasStats() {
            try {
                // Hacer visible el recuadro
                nasCounterDisplay.style.display = 'block';
                nasCounterDisplay.textContent = "Cargando...";

                const response = await fetch(NAS_URL);
                if (!response.ok) throw new Error("Error red");
                const data = await response.json();
                
                if(data && typeof data.total !== 'undefined') {
                    nasCounterDisplay.textContent = `üìä Uso Comunidad: ${data.total} usos (Gen: ${data.generador} | Calc: ${data.calculadora})`;
                }
            } catch (error) {
                console.warn("No se pudo conectar al NAS:", error);
                nasCounterDisplay.textContent = "üìä Error de conexi√≥n con el servidor.";
            }
        }

        /**
         * Funci√≥n para sumar +1 en el NAS (POST)
         */
        async function incrementNasCounter(tipo) {
            try {
                // NOTA: Al incrementar NO mostramos el contador (lo mantenemos oculto)
                // A menos que ya estuviera visible.
                const response = await fetch(NAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tipo: tipo })
                });
                // No actualizamos la vista si est√° oculta para mantener la privacidad
                if (nasCounterDisplay.style.display !== 'none') {
                    const data = await response.json();
                    nasCounterDisplay.textContent = `üìä Uso Comunidad: ${data.total} usos (Gen: ${data.generador} | Calc: ${data.calculadora})`;
                }
            } catch (error) {
                console.error("Error guardando en NAS:", error);
            }
        }


        /* ==========================================================
           L√ìGICA APP
           ========================================================== */
        
        // Referencias DOM
        const snackbar = document.getElementById('snackbar');
        const tabGenerador = document.getElementById('tab-generador');
        const tabCalculadora = document.getElementById('tab-calculadora');
        const generadorContent = document.getElementById('generador-content');
        const calculadoraContent = document.getElementById('calculadora-content');
        
        const cupsInput = document.getElementById('cupsInput');
        const quantityInput = document.getElementById('quantityInput');
        const anterioresList = document.getElementById('anterioresList');
        const posterioresList = document.getElementById('posterioresList');
        const originalesDisplay = document.getElementById('originalCupsDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const anterioresTitle = document.getElementById('anterioresTitle');
        const posterioresTitle = document.getElementById('posterioresTitle');
        const exportButton = document.getElementById('exportButton');
        const calculadoraResults = document.getElementById('calculadoraResults');

        const CUPS_REGEX = /^([A-Z]{2})(\d{4})(\d{12})(?:[A-Z]{2})?([A-Z0-9]{0,2})?/;
        const CUPS_CHAR_TABLE = "TRWAGMYFPDXBNJZSQVHLCKE";

        // --- Funciones Comunes ---
        function showSnackbar(message) {
            snackbar.textContent = message;
            snackbar.classList.add('show');
            setTimeout(() => snackbar.classList.remove('show'), 3000);
        }

        function calcularDigitosControl(dddccccccccccc) {
            try {
                const numero16Digitos = BigInt(dddccccccccccc);
                const R0 = Number(numero16Digitos % 529n);
                const C = Math.floor(R0 / 23);
                const R = R0 % 23;
                return CUPS_CHAR_TABLE.charAt(C) + CUPS_CHAR_TABLE.charAt(R);
            } catch (e) {
                console.error("Error control:", e); return "ER";
            }
        }

        async function copiarAlPortapapeles(textToCopy, btnElement) {
            try {
                await navigator.clipboard.writeText(textToCopy);
                showSnackbar(`‚úÖ CUPS copiado: ${textToCopy}`);
                if (btnElement) {
                    btnElement.classList.add('copied');
                    btnElement.textContent = '‚úî';
                }
            } catch (err) {
                console.error('Error copia:', err);
                alert('‚ùå Error al copiar.');
            }
        }

        function showTab(tabName) {
            generadorContent.style.display = 'none';
            calculadoraContent.style.display = 'none';
            tabGenerador.classList.remove('active');
            tabCalculadora.classList.remove('active');
            if (tabName === 'generador') {
                generadorContent.style.display = 'block';
                tabGenerador.classList.add('active');
            } else if (tabName === 'calculadora') {
                calculadoraContent.style.display = 'block';
                tabCalculadora.classList.add('active');
            }
        }

        // --- Funciones Generador ---
        async function copiarTodoAExcel() {
            let excelData = "";
            const tab = '\t'; const newline = '\n'; 
            const itemsAnteriores = document.querySelectorAll('#anterioresList .cups-item');
            const itemsPosteriores = document.querySelectorAll('#posterioresList .cups-item');
            Array.from(itemsAnteriores).reverse().forEach(item => {
                const cups = item.querySelector('.cups-code').textContent;
                const nota = item.querySelector('.nota-input').value;
                excelData += `${cups}${tab}${nota}${newline}`;
            });
            itemsPosteriores.forEach(item => {
                const cups = item.querySelector('.cups-code').textContent;
                const nota = item.querySelector('.nota-input').value;
                excelData += `${cups}${tab}${nota}${newline}`;
            });
            if (excelData) {
                try {
                    await navigator.clipboard.writeText(excelData.trim());
                    showSnackbar('‚úÖ Copiado para Excel.');
                } catch (err) { console.error(err); }
            } else { showSnackbar('‚ÑπÔ∏è Sin datos.'); }
        }

        function calculateFullCups(baseNumber, countryCode, distributorCode, optionalEnd) {
            const newNumericPart = baseNumber.toString().padStart(12, '0');
            const dddccccccccccc = distributorCode + newNumericPart;
            const newControlDigits = calcularDigitosControl(dddccccccccccc);
            return `${countryCode}${distributorCode}${newNumericPart}${newControlDigits}${optionalEnd || ''}`;
        }

        function generarCups() {
            const fullCups = cupsInput.value.trim().toUpperCase();
            
            // --- DETECCI√ìN DE C√ìDIGO SECRETO "CONTADOR" ---
            if (fullCups === 'CONTADOR') {
                fetchNasStats(); // Muestra el contador oculto
                statusMessage.textContent = "üîì Acceso a estad√≠sticas concedido.";
                statusMessage.style.color = "var(--color-contraste)";
                return; // Detiene la generaci√≥n
            }
            // -----------------------------------------------

            let quantity = parseInt(quantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1 || quantity > 50) { 
                quantity = 10; quantityInput.value = 10;
            }

            const match = fullCups.match(CUPS_REGEX);
            if (!match) {
                statusMessage.textContent = 'Formato CUPS inv√°lido.'; 
                statusMessage.style.color = "var(--color-error)";
                return;
            } else {
                statusMessage.textContent = '';
            }

            // Llamada al NAS (Invisible al usuario normal)
            incrementNasCounter('generador'); 

            // Limpieza UI
            anterioresList.innerHTML = '';
            posterioresList.innerHTML = '';
            originalesDisplay.style.display = 'none';
            exportButton.style.display = 'none'; 
            anterioresTitle.textContent = `${quantity} CUPS Anteriores ‚¨ÖÔ∏è`;
            posterioresTitle.textContent = `${quantity} CUPS Posteriores ‚û°Ô∏è`;

            const [_, countryCode, distributorCode, numericPart, optionalEnd] = match;
            const baseNumber = parseInt(numericPart, 10);
            
            for (let i = 1; i <= quantity; i++) {
                const itemNumber = baseNumber - i;
                const newCups = calculateFullCups(itemNumber, countryCode, distributorCode, optionalEnd);
                displayCupsItem(newCups, anterioresList, i);
            }
            for (let i = 1; i <= quantity; i++) {
                const itemNumber = baseNumber + i;
                const newCups = calculateFullCups(itemNumber, countryCode, distributorCode, optionalEnd);
                displayCupsItem(newCups, posterioresList, i);
            }
            const completeBaseCups = calculateFullCups(baseNumber, countryCode, distributorCode, optionalEnd);
            originalesDisplay.textContent = `CUPS Original: ${completeBaseCups}`;
            originalesDisplay.style.display = 'block';
            exportButton.style.display = 'inline-block';
        }

        function restablecerTodo() {
            cupsInput.value = 'ES0022000000000000XX'; 
            quantityInput.value = '10';
            anterioresList.innerHTML = '';
            posterioresList.innerHTML = '';
            statusMessage.textContent = '';
            originalesDisplay.style.display = 'none';
            exportButton.style.display = 'none';
            
            // Al restablecer, volvemos a ocultar el contador
            nasCounterDisplay.style.display = 'none';
            calculadoraResults.innerHTML = '<p>Aqu√≠ aparecer√°n los CUPS v√°lidos...</p>';
        }

        function displayCupsItem(cupsCode, targetList, listNumber) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('cups-item');
            const cupsInfo = document.createElement('div');
            cupsInfo.classList.add('cups-info');
            const numberSpan = document.createElement('span');
            numberSpan.classList.add('list-number');
            numberSpan.textContent = listNumber;
            const cupsSpan = document.createElement('span');
            cupsSpan.classList.add('cups-code');
            cupsSpan.textContent = cupsCode;
            cupsInfo.appendChild(numberSpan);
            cupsInfo.appendChild(cupsSpan);
            const notaInput = document.createElement('input');
            notaInput.type = 'text';
            notaInput.classList.add('nota-input');
            notaInput.maxLength = 12;
            cupsInfo.appendChild(notaInput);
            const copyButton = document.createElement('button');
            copyButton.classList.add('copy-btn');
            copyButton.textContent = 'Copiar';
            copyButton.onclick = () => copiarAlPortapapeles(cupsCode, copyButton);
            itemDiv.appendChild(cupsInfo);
            itemDiv.appendChild(copyButton);
            targetList.appendChild(itemDiv);
        }

        // --- Funciones Calculadora ---
        function updateInputView() {
            const mode = document.getElementById('modeSelect').value;
            if (mode === '3') {
                document.getElementById('inputGroup3').style.display = 'flex';
                document.getElementById('inputGroup4').style.display = 'none';
            } else {
                document.getElementById('inputGroup3').style.display = 'none';
                document.getElementById('inputGroup4').style.display = 'flex';
            }
            calculadoraResults.innerHTML = '<p>Aqu√≠ aparecer√°n los CUPS v√°lidos...</p>';
        }

        function findValidCups() {
            const mode = document.getElementById('modeSelect').value;
            
            // --- DETECCI√ìN DE C√ìDIGO SECRETO "CONTADOR" EN CALCULADORA ---
            const secretCheck1 = document.getElementById('cupsP1_3').value.trim().toUpperCase();
            const secretCheck2 = document.getElementById('cupsP1_4').value.trim().toUpperCase();
            
            if (secretCheck1 === 'CONTADOR' || secretCheck2 === 'CONTADOR') {
                fetchNasStats(); // Muestra el contador oculto
                calculadoraResults.innerHTML = "<p>üîì <strong>Acceso a estad√≠sticas concedido.</strong> Mira en la cabecera.</p>";
                return; // Detiene el c√°lculo
            }
            // --------------------------------------------------------------

            let p1_known, p2_suffix, p1_length, loopMax, padLength, errorMsg;
            if (mode === '3') {
                p1_known = document.getElementById('cupsP1_3').value;
                p2_suffix = document.getElementById('cupsP2_3').value.toUpperCase();
                p1_length = 9; loopMax = 999; padLength = 3;
                errorMsg = '<p class="error">Error: 9 d√≠gitos num√©ricos.</p>';
                calculadoraResults.innerHTML = "<p>Calculando...</p>";
            } else {
                p1_known = document.getElementById('cupsP1_4').value;
                p2_suffix = document.getElementById('cupsP2_4').value.toUpperCase();
                p1_length = 8; loopMax = 9999; padLength = 4;
                errorMsg = '<p class="error">Error: 8 d√≠gitos num√©ricos.</p>';
                calculadoraResults.innerHTML = "<p>Calculando...</p>";
            }

            if (p1_known.length !== p1_length || !/^\d+$/.test(p1_known)) {
                calculadoraResults.innerHTML = errorMsg; return;
            }
            if (p2_suffix.length !== 6) {
                 calculadoraResults.innerHTML = '<p class="error">Error formato YYYYCC.</p>'; return;
            }

            // Llamada al NAS (Invisible al usuario normal)
            incrementNasCounter('calculadora');

            const p3_known = p2_suffix.substring(0, 4);
            const expectedControls = p2_suffix.substring(4, 6);
            const validResults = [];
            for (let i = 0; i <= loopMax; i++) {
                const p2_unknown = i.toString().padStart(padLength, '0');
                const N_string = p1_known + p2_unknown + p3_known;
                const calculatedControls = calcularDigitosControl(N_string);
                if (calculatedControls === expectedControls) {
                    validResults.push("ES" + p1_known + p2_unknown + p3_known + expectedControls);
                }
            }
            if (validResults.length > 0) {
                calculadoraResults.innerHTML = validResults.join('<br>');
            } else {
                calculadoraResults.innerHTML = "<p>No se encontraron.</p>";
            }
        }

        // Hacer globales
        window.copiarAlPortapapeles = copiarAlPortapapeles;
        window.generarCups = generarCups;
        window.restablecerTodo = restablecerTodo;
        window.copiarTodoAExcel = copiarTodoAExcel;
        window.findValidCups = findValidCups; 
        window.updateInputView = updateInputView;
        window.showTab = showTab;
    </script>
</body>
</html>


