<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramientas CUPS (Firebase Cloud)</title>
    <style>
        /* PALETA 60-30-10 (Pastel) */
        :root {
            --color-dominante: #F5F5F5;
            --color-secundARIO: #E8EAF6;
            --color-acento: #A8DAD7;
            --color-contraste: #6A5ACD;
            --color-texto-general: #555555;
            --color-error: #d9534f;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--color-secundario);
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            flex-direction: column;
        }
        .logo-title-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            background-color: var(--color-contraste);
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo img {
            content: url("Captura de pantalla 2025-10-09 183230.png");
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px;
            background-color: var(--color-dominante);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: var(--color-contraste);
            text-align: center;
            border-bottom: 2px solid var(--color-acento);
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        
        /* Estilo para el contador global (Oculto por defecto) */
        .global-counter {
            font-size: 0.9em;
            color: var(--color-texto-general);
            background-color: var(--color-acento);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            opacity: 0.8;
            margin-top: 10px;
            cursor: pointer;
        }

        h2 {
            color: var(--color-contraste);
            font-size: 1.3em;
            margin-top: 20px;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--color-acento);
        }
        
        /* TABS */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--color-acento);
            padding-bottom: 15px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background-color: var(--color-secundario);
            color: var(--color-texto-general);
            border: 1px solid var(--color-acento);
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        .tab-btn:hover { background-color: var(--color-acento); }
        .tab-btn.active {
            background-color: var(--color-contraste);
            color: white;
            border-color: var(--color-contraste);
        }
        .tab-btn.active:hover { background-color: #5d49b2; }
        
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        .input-group label {
            font-weight: bold;
            color: var(--color-contraste);
            white-space: nowrap;
        }
        
        input[type="text"], input[type="number"], select {
            padding: 12px;
            border: 1px solid var(--color-contraste);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: white;
            color: var(--color-texto-general);
        }
        input[type="text"], select { flex: 2; }
        input[type="number"] { flex: 1; max-width: 120px; text-align: center; }

        button {
            padding: 12px 20px;
            cursor: pointer;
            background-color: var(--color-contraste);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #5d49b2; }

        button.reset-btn {
            background-color: var(--color-acento);
            color: var(--color-texto-general);
        }
        button.reset-btn:hover { background-color: #88c8c5; }

        .export-controls { text-align: right; margin-bottom: 15px; }
        button.export-btn {
            background-color: var(--color-acento);
            color: var(--color-texto-general);
            padding: 8px 15px;
            font-size: 0.9em;
        }
        button.export-btn:hover { background-color: #88c8c5; }

        #statusMessage {
            color: var(--color-error);
            margin-top: 15px;
            font-weight: bold;
        }
        .results-grid { display: flex; gap: 20px; margin-top: 20px; }
        .column {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            background-color: var(--color-secundario);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }
        .cups-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border: 1px solid var(--color-acento);
            border-radius: 6px;
        }
        .cups-info { display: flex; align-items: center; gap: 10px; }
        .list-number {
            font-weight: bold;
            color: white;
            background-color: var(--color-contraste);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .cups-code {
            font-family: monospace;
            font-size: 1.05em;
            color: var(--color-contraste);
            font-weight: bold;
        }
        .nota-input {
            padding: 0 6px;    
            border: 1px solid var(--color-acento);
            border-radius: 4px;  
            font-size: 0.7em;    
            width: 120px; 
            box-sizing: border-box; 
            font-family: monospace;
            color: var(--color-texto-general);
        }
        .copy-btn {
            padding: 6px 10px;
            background-color: var(--color-acento);
            color: var(--color-texto-general);
            font-size: 0.9em;
        }
        .copy-btn:hover { background-color: #88c8c5; }
        .copy-btn.copied {
            background-color: var(--color-secundario);
            color: var(--color-texto-general);
            border: 1px solid var(--color-acento);
        }
        .copy-btn.copied:hover { background-color: #88c8c5; }

        .original-cups {
            background-color: #FFDDAA;
            color: var(--color-texto-general);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* CALCULADORA */
        #calculadora-content .input-prefix {
            padding: 8px 12px;
            font-weight: bold;
            color: var(--color-contraste);
            background-color: var(--color-secundario);
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1em;
            white-space: nowrap;
        }
        #calculadora-content input[type="text"] {
            font-family: monospace;
            letter-spacing: 1px;
            font-size: 1.05em;
            text-align: center;
        }
        #calculadoraResults {
            min-height: 200px; 
            max-height: 400px; 
            overflow-y: auto;
            font-family: monospace;
            font-size: 1.05em;
            color: var(--color-contraste);
            line-height: 1.6;
        }
        #calculadoraResults p {
            color: var(--color-texto-general);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1em;
            font-weight: normal;
        }
        .error {
            color: var(--color-error);
            font-weight: bold;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* SNACKBAR */
        #snackbar {
            visibility: hidden;
            min-width: 280px;
            margin-left: -140px;
            background-color: var(--color-contraste);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        #snackbar.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        .page-footer {
            text-align: center;
            padding: 20px;
            font-size: 0.8em;
            color: var(--color-texto-general);
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-title-wrapper">
                <div class="logo">
                    </div>
                <h1>Herramientas CUPS</h1>
            </div>
            <div id="nasCounterDisplay" class="global-counter" style="display: none;">
                Cargando datos...
            </div>
        </div>

        <div class="tab-nav">
            <button id="tab-generador" class="tab-btn active" onclick="showTab('generador')">Generador Secuencial üîÑ</button>
            <button id="tab-calculadora" class="tab-btn" onclick="showTab('calculadora')">Completar CUPS üîç</button>
        </div>

        <div id="generador-content">
            <p>Introduce el CUPS base y la cantidad de c√≥digos anteriores y posteriores que deseas generar.</p>
            <div class="input-group">
                <label for="cupsInput">CUPS Base:</label>
                <input type="text" id="cupsInput" placeholder="Ej: ES0022000000000000" value="ES0022000000000000XX">
                <label for="quantityInput">Cantidad:</label>
                <input type="number" id="quantityInput" value="10" min="1" max="50">
                <button onclick="generarCups()">Generar</button>
                <button onclick="restablecerTodo()" class="reset-btn">Restablecer</button>
            </div>
            <div id="statusMessage"></div>
            <div id="originalCupsDisplay" class="original-cups" style="display: none;"></div>
            <hr>
            <div class="export-controls">
                <button id="exportButton" class="export-btn" onclick="copiarTodoAExcel()" style="display: none;">
                    Copiar Todo para Excel üìã
                </button>
            </div>
            <div class="results-grid">
                <div class="column">
                    <h2 id="anterioresTitle">CUPS Anteriores ‚¨ÖÔ∏è</h2>
                    <div id="anterioresList"></div>
                </div>
                <div class="column">
                    <h2 id="posterioresTitle">CUPS Posteriores ‚û°Ô∏è</h2>
                    <div id="posterioresList"></div>
                </div>
            </div>
        </div>

        <div id="calculadora-content" style="display: none;">
            <h2>Completar CUPS</h2>
            <div class="input-group">
                <label for="modeSelect">Modo de C√°lculo:</label>
                <select id="modeSelect" onchange="updateInputView()">
                    <option value="3" selected>Faltan 3 d√≠gitos (ES...XXX...)</option>
                    <option value="4">Faltan 4 d√≠gitos (ES...XXXX...)</option>
                </select>
            </div>
            <p>Introduce las partes conocidas (Y) del CUPS:</p>
            <div id="inputGroup3" class="input-group">
                <label>CUPS (sin 3 d√≠gitos):</label>
                <span class="input-prefix">ES</span>
                <input type="text" id="cupsP1_3" maxlength="9" placeholder="YYYYYYYYY" list="predefined-p1" style="flex: 2;">
                <datalist id="predefined-p1">
                    <option value="002200000">
                    <option value="002100000">
                    <option value="002100001">
                </datalist>
                <span class="input-prefix">XXX</span>
                <input type="text" id="cupsP2_3" maxlength="6" placeholder="YYYYCC" style="flex: 1; max-width: 140px;">
            </div>
            <div id="inputGroup4" class="input-group" style="display: none;">
                <label>CUPS (sin 4 d√≠gitos):</label>
                <span class="input-prefix">ES</span>
                <input type="text" id="cupsP1_4" maxlength="8" placeholder="YYYYYYYY" style="flex: 2;">
                <span class="input-prefix">XXXX</span>
                <input type="text" id="cupsP2_4" maxlength="6" placeholder="YYYYCC" style="flex: 1; max-width: 140px;">
            </div>
            <div class="input-group">
                <button onclick="findValidCups()" style="width: 100%;">Calcular Posibles CUPS</button>
            </div>
            <h3>Resultados:</h3>
            <div id="calculadoraResults" class="column">
                <p>Aqu√≠ aparecer√°n los CUPS v√°lidos...</p>
            </div>
        </div>
    </div> 

    <footer class="page-footer">Creado por Fran T.</footer>
    <div id="snackbar"></div>

    <script type="module">
        // ---------------------------------------------------------
        // 1. IMPORTAR FUNCIONES DE FIREBASE (Enlaces CDN para navegador)
        // ---------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getDatabase, ref, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ---------------------------------------------------------
        // 2. CONFIGURACI√ìN FIREBASE (TUS DATOS REALES)
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBb10iMuEs-pseqxtWCIWc6rLv1ONfmd8c",
            authDomain: "generador-cups.firebaseapp.com",
            projectId: "generador-cups",
            storageBucket: "generador-cups.firebasestorage.app",
            messagingSenderId: "426484255342",
            appId: "1:426484255342:web:af7382b03e04dfd6abf47f",
            measurementId: "G-58CFJDQ4V7",
            // A√ëADIDO: Esta es la URL est√°ndar. Si no funciona, verifica en tu consola.
            databaseURL: "https://generador-cups-default-rtdb.firebaseio.com"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // Iniciamos Analytics como ped√≠a tu c√≥digo
        const db = getDatabase(app);

        // ---------------------------------------------------------
        // 3. L√ìGICA DE CONTADORES (BACKEND FIREBASE)
        // ---------------------------------------------------------
        
        // Referencias a los contadores en la base de datos
        const statsRef = ref(db, 'estadisticas');
        const nasCounterDisplay = document.getElementById('nasCounterDisplay');

        // Funci√≥n para mostrar estad√≠sticas en tiempo real (Listener)
        // Se activa cuando el usuario pone "CONTADOR"
        function escucharEstadisticas() {
            onValue(statsRef, (snapshot) => {
                const data = snapshot.val() || { total: 0, generador: 0, calculadora: 0, unicos: 0 };
                
                // Mostrar en pantalla
                nasCounterDisplay.style.display = 'block';
                nasCounterDisplay.innerHTML = `
                    üìä <strong>Estad√≠sticas Firebase</strong><br>
                    Total Usos: ${data.total} (Gen: ${data.generador || 0} | Calc: ${data.calculadora || 0})<br>
                    üë• Usuarios √önicos: ${data.unicos || 0}
                `;
            });
        }

        // Funci√≥n para incrementar contadores (Transacci√≥n segura)
        async function incrementarFirebase(tipo) {
            // 1. Incrementar contador espec√≠fico (generador o calculadora)
            const especificoRef = ref(db, `estadisticas/${tipo}`);
            runTransaction(especificoRef, (current) => (current || 0) + 1);

            // 2. Incrementar total global
            const totalRef = ref(db, `estadisticas/total`);
            runTransaction(totalRef, (current) => (current || 0) + 1);

            // 3. Gestionar Usuarios √önicos (Local Storage)
            // Si el usuario no tiene la marca 'app_usada', es nuevo
            if (!localStorage.getItem('app_usada')) {
                const unicosRef = ref(db, `estadisticas/unicos`);
                runTransaction(unicosRef, (current) => (current || 0) + 1);
                
                // Le ponemos la marca para no volver a contarlo
                localStorage.setItem('app_usada', 'true');
            }
        }

        // ---------------------------------------------------------
        // 4. L√ìGICA DE LA APLICACI√ìN (FRONTEND)
        // ---------------------------------------------------------
        
        // Al usar type="module", las funciones no son globales. 
        // Las asignamos a window para que los botones onclick funcionen.
        
        const snackbar = document.getElementById('snackbar');
        const statusMessage = document.getElementById('statusMessage');

        // --- FUNCIONES L√ìGICAS COMUNES ---
        const CUPS_CHAR_TABLE = "TRWAGMYFPDXBNJZSQVHLCKE";

        function showSnackbar(message) {
            snackbar.textContent = message;
            snackbar.classList.add('show');
            setTimeout(() => snackbar.classList.remove('show'), 3000);
        }

        function calcularDigitosControl(dddccccccccccc) {
            try {
                const numero16Digitos = BigInt(dddccccccccccc);
                const R0 = Number(numero16Digitos % 529n);
                const C = Math.floor(R0 / 23);
                const R = R0 % 23;
                return CUPS_CHAR_TABLE.charAt(C) + CUPS_CHAR_TABLE.charAt(R);
            } catch (e) { return "ER"; }
        }

        window.copiarAlPortapapeles = async function(textToCopy, btnElement) {
            try {
                await navigator.clipboard.writeText(textToCopy);
                showSnackbar(`‚úÖ CUPS copiado: ${textToCopy}`);
                if (btnElement) {
                    btnElement.classList.add('copied');
                    btnElement.textContent = '‚úî';
                }
            } catch (err) { alert('‚ùå Error al copiar.'); }
        };

        window.showTab = function(tabName) {
            document.getElementById('generador-content').style.display = 'none';
            document.getElementById('calculadora-content').style.display = 'none';
            document.getElementById('tab-generador').classList.remove('active');
            document.getElementById('tab-calculadora').classList.remove('active');
            if (tabName === 'generador') {
                document.getElementById('generador-content').style.display = 'block';
                document.getElementById('tab-generador').classList.add('active');
            } else {
                document.getElementById('calculadora-content').style.display = 'block';
                document.getElementById('tab-calculadora').classList.add('active');
            }
        };

        // --- GENERADOR ---
        function calculateFullCups(baseNumber, countryCode, distributorCode, optionalEnd) {
            const newNumericPart = baseNumber.toString().padStart(12, '0');
            const dddccccccccccc = distributorCode + newNumericPart;
            const newControlDigits = calcularDigitosControl(dddccccccccccc);
            return `${countryCode}${distributorCode}${newNumericPart}${newControlDigits}${optionalEnd || ''}`;
        }

        window.generarCups = function() {
            const cupsInput = document.getElementById('cupsInput');
            const quantityInput = document.getElementById('quantityInput');
            const fullCups = cupsInput.value.trim().toUpperCase();

            // DETECCI√ìN C√ìDIGO SECRETO
            if (fullCups === 'CONTADOR') {
                escucharEstadisticas(); // Activa el listener de Firebase
                statusMessage.textContent = "üîì Conectado a Firebase.";
                statusMessage.style.color = "var(--color-contraste)";
                return;
            }

            // Validaciones
            let quantity = parseInt(quantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1 || quantity > 50) quantity = 10;
            const match = fullCups.match(/^([A-Z]{2})(\d{4})(\d{12})(?:[A-Z]{2})?([A-Z0-9]{0,2})?/);
            
            if (!match) {
                statusMessage.textContent = 'Formato CUPS inv√°lido.'; 
                statusMessage.style.color = "var(--color-error)";
                return;
            } else {
                statusMessage.textContent = '';
            }

            // INCREMENTAR FIREBASE
            incrementarFirebase('generador');

            // L√≥gica de generaci√≥n visual
            const anterioresList = document.getElementById('anterioresList');
            const posterioresList = document.getElementById('posterioresList');
            anterioresList.innerHTML = ''; posterioresList.innerHTML = '';
            document.getElementById('originalCupsDisplay').style.display = 'none';
            document.getElementById('exportButton').style.display = 'none';
            
            document.getElementById('anterioresTitle').textContent = `${quantity} CUPS Anteriores ‚¨ÖÔ∏è`;
            document.getElementById('posterioresTitle').textContent = `${quantity} CUPS Posteriores ‚û°Ô∏è`;

            const [_, countryCode, distributorCode, numericPart, optionalEnd] = match;
            const baseNumber = parseInt(numericPart, 10);

            const displayItem = (cups, list, num) => {
                const div = document.createElement('div'); div.className = 'cups-item';
                div.innerHTML = `
                    <div class="cups-info">
                        <span class="list-number">${num}</span>
                        <span class="cups-code">${cups}</span>
                        <input type="text" class="nota-input" maxlength="12">
                    </div>`;
                const btn = document.createElement('button'); btn.className = 'copy-btn'; btn.textContent = 'Copiar';
                btn.onclick = () => window.copiarAlPortapapeles(cups, btn);
                div.appendChild(btn);
                list.appendChild(div);
            };

            for (let i = 1; i <= quantity; i++) {
                displayItem(calculateFullCups(baseNumber - i, countryCode, distributorCode, optionalEnd), anterioresList, i);
                displayItem(calculateFullCups(baseNumber + i, countryCode, distributorCode, optionalEnd), posterioresList, i);
            }
            
            const origDiv = document.getElementById('originalCupsDisplay');
            origDiv.textContent = `CUPS Original: ${calculateFullCups(baseNumber, countryCode, distributorCode, optionalEnd)}`;
            origDiv.style.display = 'block';
            document.getElementById('exportButton').style.display = 'inline-block';
        };

        window.restablecerTodo = function() {
            document.getElementById('cupsInput').value = 'ES0022000000000000XX';
            document.getElementById('quantityInput').value = '10';
            document.getElementById('anterioresList').innerHTML = '';
            document.getElementById('posterioresList').innerHTML = '';
            statusMessage.textContent = '';
            document.getElementById('originalCupsDisplay').style.display = 'none';
            document.getElementById('exportButton').style.display = 'none';
            document.getElementById('nasCounterDisplay').style.display = 'none'; // Ocultar contador
            document.getElementById('calculadoraResults').innerHTML = '<p>Aqu√≠ aparecer√°n los CUPS v√°lidos...</p>';
        };

        window.copiarTodoAExcel = async function() {
            // (Misma l√≥gica de Excel anterior...)
            let excelData = ""; const tab = '\t'; const newline = '\n';
            const items = [...document.querySelectorAll('#anterioresList .cups-item')].reverse()
                .concat([...document.querySelectorAll('#posterioresList .cups-item')]);
            
            items.forEach(item => {
                excelData += `${item.querySelector('.cups-code').textContent}${tab}${item.querySelector('.nota-input').value}${newline}`;
            });
            
            if (excelData) {
                try { await navigator.clipboard.writeText(excelData.trim()); showSnackbar('‚úÖ Copiado para Excel.'); }
                catch (e) { console.error(e); }
            }
        };

        // --- CALCULADORA ---
        window.updateInputView = function() {
            const mode = document.getElementById('modeSelect').value;
            document.getElementById('inputGroup3').style.display = mode === '3' ? 'flex' : 'none';
            document.getElementById('inputGroup4').style.display = mode === '4' ? 'flex' : 'none';
            document.getElementById('calculadoraResults').innerHTML = '<p>Aqu√≠ aparecer√°n los CUPS v√°lidos...</p>';
        };

        window.findValidCups = function() {
            const mode = document.getElementById('modeSelect').value;
            const resDiv = document.getElementById('calculadoraResults');

            // DETECCI√ìN SECRETO EN CALCULADORA
            const s1 = document.getElementById('cupsP1_3').value.trim().toUpperCase();
            const s2 = document.getElementById('cupsP1_4').value.trim().toUpperCase();
            if (s1 === 'CONTADOR' || s2 === 'CONTADOR') {
                escucharEstadisticas();
                resDiv.innerHTML = "<p>üîì <strong>Conectado a Firebase.</strong> Mira arriba.</p>";
                return;
            }

            // INCREMENTAR FIREBASE
            incrementarFirebase('calculadora');

            let p1, p2, len, max, pad, msg;
            if (mode === '3') {
                p1 = document.getElementById('cupsP1_3').value; p2 = document.getElementById('cupsP2_3').value.toUpperCase();
                len = 9; max = 999; pad = 3; msg = '9 d√≠gitos';
            } else {
                p1 = document.getElementById('cupsP1_4').value; p2 = document.getElementById('cupsP2_4').value.toUpperCase();
                len = 8; max = 9999; pad = 4; msg = '8 d√≠gitos';
            }

            resDiv.innerHTML = "<p>Calculando...</p>";
            if (p1.length !== len || !/^\d+$/.test(p1)) { resDiv.innerHTML = `<p class="error">Error: ${msg}</p>`; return; }
            if (p2.length !== 6) { resDiv.innerHTML = '<p class="error">Error YYYYCC</p>'; return; }

            const p3 = p2.substring(0, 4);
            const ctrl = p2.substring(4, 6);
            const results = [];

            for (let i = 0; i <= max; i++) {
                const unknown = i.toString().padStart(pad, '0');
                const full = p1 + unknown + p3;
                if (calcularDigitosControl(full) === ctrl) {
                    results.push("ES" + p1 + unknown + p3 + ctrl);
                }
            }
            
            resDiv.innerHTML = results.length > 0 ? results.join('<br>') : "<p>No se encontraron.</p>";
        };
    </script>
</body>
</html>
